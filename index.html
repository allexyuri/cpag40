<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Taxas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Não são mais necessários os SDKs do Firebase -->
    <style>
        /* Estilos para o modal personalizado */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        .modal-buttons {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        /* Estilos para o menu hambúrguer */
        .hamburger-menu {
            display: none; /* Hidden by default, shown on small screens */
            cursor: pointer;
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 25px;
        }
        .hamburger-menu span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: #333;
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
        }

        /* Animação do hambúrguer para X */
        .hamburger-menu.open span:nth-child(1) {
            transform: translateY(11px) rotate(45deg);
        }
        .hamburger-menu.open span:nth-child(2) {
            opacity: 0;
        }
        .hamburger-menu.open span:nth-child(3) {
            transform: translateY(-11px) rotate(-45deg);
        }

        /* Estilos para o menu de navegação responsivo */
        @media (max-width: 1023px) { /* Tailwind's 'lg' breakpoint is 1024px */
            .hamburger-menu {
                display: flex; /* Show hamburger on small screens */
            }
            #main-nav-container {
                display: none; /* Hide main nav by default on small screens */
                flex-direction: column;
                position: absolute;
                top: 60px; /* Adjust based on header height */
                right: 1rem;
                background-color: white;
                border-radius: 0.5rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                width: 200px;
                padding: 1rem;
                gap: 0.5rem;
                z-index: 900;
            }
            #main-nav-container.open {
                display: flex; /* Show dropdown when open */
            }
            .page-nav-button {
                width: 100%; /* Full width buttons in dropdown */
            }
            header .container { /* Adicionado para garantir que o flex-wrap não afete o container principal */
                flex-wrap: wrap;
            }
            header nav {
                width: 100%; /* Nav takes full width below logo on small screens */
                margin-top: 1rem;
            }
        }

        /* Estilos para o rodapé fixo na parte inferior e o novo plano de fundo em degradê */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Garante que o corpo ocupe pelo menos 100% da altura da viewport */
            background: linear-gradient(to bottom right, #f97316, #fb923c, #fdba74); /* Degradê laranja */
            background-attachment: fixed; /* Mantém o plano de fundo fixo ao rolar */
        }
        footer {
            margin-top: auto; /* Empurra o rodapé para a parte inferior */
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="w-full sticky top-0 z-50 bg-white shadow-md py-2 sm:py-3 lg:py-4">
        <div class="container mx-auto max-w-screen-xl flex items-center justify-between">
            <div class="flex items-center">
                <img src="logocolorida.svg" alt="Logo da Empresa" class="h-10 w-auto rounded-md mr-4">
                <span class="font-bold text-lg text-gray-900 whitespace-nowrap">CPAG 40</span>
            </div>
            
            <!-- Hamburger Menu Icon for Mobile -->
            <div id="hamburger-icon" class="hamburger-menu lg:hidden mr-2">
                <span></span>
                <span></span>
                <span></span>
            </div>

            <nav class="flex-grow min-w-0 lg:flex lg:justify-end">
                <div id="main-nav-container" class="flex flex-wrap justify-end gap-2 lg:flex">
                    <button class="page-nav-button px-4 py-2 text-sm font-medium rounded-md shadow-sm border border-orange-300 hover:bg-orange-200 transition-colors bg-orange-500 text-white" data-page="custom-profile-page" aria-selected="true">Perfil Personalizado</button>
                    <button class="page-nav-button px-4 py-2 text-sm font-medium rounded-md shadow-sm border border-orange-300 hover:bg-orange-200 transition-colors bg-orange-100 text-orange-800" data-page="comparison-details-page" aria-selected="false">Detalhes da Comparação</button>
                    <button class="page-nav-button px-4 py-2 text-sm font-medium rounded-md shadow-sm border border-orange-300 hover:bg-orange-200 transition-colors bg-orange-100 text-orange-800" data-page="calculators-page" aria-selected="false">Calculadoras</button>
                    <button class="page-nav-button px-4 py-2 text-sm font-medium rounded-md shadow-sm border border-orange-300 hover:bg-orange-200 transition-colors bg-orange-100 text-orange-800" data-page="chart-page" aria-selected="false">Gráfico</button>
                </div>
            </nav>
        </div>
    </header>
    
    <!-- A seção de fundo com degradê em forma de ondas foi removida -->

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-screen-xl flex-grow">
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div id="custom-profile-page" class="page-content lg:col-span-2">
                <section class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h2 class="text-xl font-bold mb-4 flex justify-between items-center">
                        Taxas da Operadora Atual
                        <button id="toggle-custom-profile" class="text-blue-600 hover:text-blue-800 focus:outline-none text-2xl font-bold leading-none">
                            +
                        </button>
                    </h2>
                    <div id="custom-profile-content" class="hidden">
                        <p class="text-sm text-slate-500 mb-6">Defina um novo perfil de taxas para comparação. Insira as taxas da bandeira para cada parcela (1x a 18x).</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="custom-profile-name" class="block text-sm font-medium text-gray-700">Nome do Perfil</label>
                                <input type="text" id="custom-profile-name" placeholder="Meu Perfil de Teste" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="custom-service-rate" class="block text-sm font-medium text-gray-700">Taxa de Serviço/Alíquota (%)</label>
                                <input type="number" id="custom-service-rate" placeholder="2.00" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="custom-rate-pix" class="block text-sm font-medium text-gray-700">Taxa da Bandeira (PIX) %</label>
                                <input type="number" id="custom-rate-pix" placeholder="0.99" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="custom-rate-debit" class="block text-sm font-medium text-gray-700">Taxa da Bandeira (Débito) %</label>
                                <input type="number" id="custom-rate-debit" placeholder="1.00" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="custom-max-parcelas" class="block text-sm font-medium text-gray-700">Máximo de Parcelas para Comparativo</label>
                                <input type="number" id="custom-max-parcelas" placeholder="Ex: 12 (até 18)" min="1" max="18" value="18" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div id="parcelado-inputs-container" class="lg:col-span-3 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                <div class="col-span-full text-sm font-semibold text-gray-700 mt-2 mb-1">Taxas da Bandeira (Parcelado por X) %</div>
                            </div>
                        </div>
                        <button id="add-custom-profile" class="mt-6 w-full bg-blue-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-blue-700 transition-colors font-medium">Adicionar Perfil Personalizado</button>
                        <div id="add-profile-feedback" class="mt-2 text-sm text-center text-green-600 hidden">Perfil adicionado com sucesso!</div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4">Perfis Personalizados Salvos</h3>
                    <div id="saved-custom-profiles-list" class="space-y-2">
                        <p class="text-sm text-gray-500" id="no-custom-profiles-message">Nenhum perfil personalizado salvo ainda.</p>
                        <!-- A mensagem de carregamento não é mais necessária sem o Firebase -->
                    </div>
                </section>
            </div>

            <div id="comparison-details-page" class="page-content hidden lg:col-span-2">
                <section class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h2 class="text-xl font-bold mb-4">Detalhes da Comparação por Forma de Pagamento</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Forma de Pagamento</th>
                                    <th scope="col" rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Bruto</th>
                                    <th scope="col" colspan="4" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 bg-blue-200" id="table-header-profile1-group"></th>
                                    <th scope="col" colspan="4" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 bg-green-200" id="table-header-profile2-group"></th>
                                    <th scope="col" colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 bg-yellow-200">Economia Athos Pay</th>
                                </tr>
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-100">Bandeira (%)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-100">Serviço (%)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-100">CET (%)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-100">Líquido (R$)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-green-100">Bandeira (%)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-green-100">Serviço<br>Alíquota (%)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-green-100">CET (%)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-green-100">Líquido (R$)</th>
                                    <th scope="col" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-yellow-100">Economia (R$)</th>
                                    <th scope="col" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-yellow-100">Economia (%)</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-table-body">
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="calculators-page" class="page-content hidden lg:col-span-2">
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">Athos Pay <span id="calc-title-1" class="text-base text-slate-600 font-normal"></span></h2>
                    <p class="text-sm text-slate-500 mb-6">Insira o valor da venda para ver as taxas aplicadas e o valor líquido a receber.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="profile-select-1" class="block text-sm font-medium text-gray-700">Perfil de Taxas</label>
                            <select id="profile-select-1" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                        </div>
                        <div>
                            <label for="sale-amount-1" class="block text-sm font-medium text-gray-700">Valor da Venda (R$)</label>
                            <input type="number" id="sale-amount-1" placeholder="100.00" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="payment-method-1" class="block text-sm font-medium text-gray-700">Forma de Pagamento</label>
                            <select id="payment-method-1" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                        </div>
                    </div>
                    <div id="results-container-1" class="mt-6 pt-6 border-t border-slate-200 space-y-3 hidden">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Taxa de Serviço:</span>
                            <span id="result-service-fee-1" class="font-medium text-gray-800"></span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Taxa da Bandeira:</span>
                            <span id="result-rate-1" class="font-medium text-gray-800"></span>
                        </div>
                        <div class="flex justify-between items-center text-lg">
                            <span class="font-semibold text-red-600">Custo Total (CET):</span>
                            <span id="result-cet-1" class="font-bold text-red-600"></span>
                        </div>
                        <div class="flex justify-between items-center text-lg mt-4 bg-green-100 p-3 rounded-lg">
                            <span class="font-semibold text-green-800">Valor Líquido a Receber:</span>
                            <span id="result-net-1" class="font-bold text-green-800"></span>
                        </div>
                    </div>
                    <button id="clear-calc-1" class="mt-6 w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md shadow-sm hover:bg-gray-300 transition-colors font-medium">Limpar</button>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4" id="calc-title-2"></h2>
                    <p class="text-sm text-slate-500 mb-6">Compare com um perfil de taxas personalizado.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="profile-select-2" class="block text-sm font-medium text-gray-700">Perfil Personalizado</label>
                            <select id="profile-select-2" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                        </div>
                        <div>
                            <label for="sale-amount-2" class="block text-sm font-medium text-gray-700">Valor da Venda (R$)</label>
                            <input type="number" id="sale-amount-2" placeholder="100.00" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="payment-method-2" class="block text-sm font-medium text-gray-700">Forma de Pagamento</label>
                            <select id="payment-method-2" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                        </div>
                    </div>
                    <div id="results-container-2" class="mt-6 pt-6 border-t border-slate-200 space-y-3 hidden">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Taxa de Serviço/Alíquota:</span>
                            <span id="result-service-fee-2" class="font-medium text-gray-800"></span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Taxa da Bandeira:</span>
                            <span id="result-rate-2" class="font-medium text-gray-800"></span>
                        </div>
                        <div class="flex justify-between items-center text-lg">
                            <span class="font-semibold text-red-600">Custo Total (CET):</span>
                            <span id="result-cet-2" class="font-bold text-red-600"></span>
                        </div>
                        <div class="flex justify-between items-center text-lg mt-4 bg-green-100 p-3 rounded-lg">
                            <span class="font-semibold text-green-800">Valor Líquido a Receber:</span>
                            <span id="result-net-2" class="font-bold text-green-800"></span>
                        </div>
                    </div>
                    <button id="clear-calc-2" class="mt-6 w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md shadow-sm hover:bg-gray-300 transition-colors font-medium">Limpar</button>
                </section>
            </div>

            <div id="chart-page" class="page-content hidden lg:col-span-2">
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-1">Comparativo de Economia (CET) por Forma de Pagamento <span id="chart-title-profiles" class="text-base text-slate-600 font-normal"></span></h2>
                    <p class="text-sm text-slate-500 mb-4">A linha verde indica o perfil com menor CET (maior economia). As linhas do gráfico terminam na parcela máxima definida para cada perfil.</p>
                    <div class="chart-container">
                        <canvas id="rateChart"></canvas>
                    </div>
                </section>
            </div>

        </main>
    </div>
    
    <footer class="w-full py-4 bg-blue-950 text-white text-center text-sm mt-4">
        <p>Esta é uma aplicação demonstrativa para fins de análise e não possui vínculo comercial direto.</p>
    </footer>

    <!-- O modal personalizado ainda é útil para mensagens gerais, mesmo sem Firebase -->
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <p id="modal-message" class="text-gray-800 text-lg mb-4"></p>
            <div class="modal-buttons">
                <button id="modal-close-button">OK</button>
            </div>
        </div>
    </div>

    <script>
        // customProfiles agora é apenas um objeto local.
        let customProfiles = {}; 
        let currentBrand = "PIX/Visa"; // Marca principal selecionada pelos botões de navegação
        let chartInstance = null; // Instância do Chart.js
        let currentPage = 'custom-profile-page'; // Página inicial padrão
        let editingProfileName = null; // Variável para controlar qual perfil está sendo editado

        // Define as taxas pré-definidas para diferentes bandeiras
        const allRates = {
            "PIX/Visa": [
                { "display": "PIX", "forma": "PIX", "taxa": 0.99, "servico": 2, "cet": 2.99 },
                { "display": "Débito", "forma": "Débito", "taxa": 1.05, "servico": 2, "cet": 3.05 },
                ...Array.from({ length: 18 }, (_, i) => {
                    const parcelas = i + 1;
                    const cetMap = { 1: 6.27, 2: 8.02, 3: 9.47, 4: 10.91, 5: 12.36, 6: 13.80, 7: 15.61, 8: 17.05, 9: 18.49, 10: 19.92, 11: 21.36, 12: 22.80, 13: 25.24, 14: 26.66, 15: 28.08, 16: 29.50, 17: 30.91, 18: 32.33 };
                    const cet = cetMap[parcelas];
                    return { "display": `Parcelado ${parcelas}x`, "forma": `Parcelado ${parcelas}x`, "taxa": parseFloat((cet - 3).toFixed(2)), "servico": 3, "cet": cet };
                })
            ],
            "Mastercard": [
                { "display": "Débito", "forma": "Débito", "taxa": 1.39, "servico": 2, "cet": 3.39 },
                ...Array.from({ length: 18 }, (_, i) => {
                    const parcelas = i + 1;
                    const cetMap = { 1: 6.49, 2: 8.89, 3: 10.29, 4: 11.67, 5: 13.07, 6: 14.44, 7: 16.35, 8: 17.77, 9: 19.20, 10: 20.62, 11: 22.05, 12: 23.48, 13: 25.88, 14: 27.28, 15: 28.69, 16: 30.09, 17: 31.50, 18: 32.90 };
                    const cet = cetMap[parcelas];
                    return { "display": `Parcelado ${parcelas}x`, "forma": `Parcelado ${parcelas}x`, "taxa": parseFloat((cet - 3).toFixed(2)), "servico": 3, "cet": cet };
                })
            ],
            "Elo": Array.from({ length: 18 }, (_, i) => {
                const parcelas = i + 1;
                const cetMap = { 1: 6.49, 2: 8.68, 3: 10.12, 4: 11.67, 5: 12.99, 6: 14.42, 7: 16.35, 8: 17.77, 9: 19.20, 10: 20.62, 11: 22.05, 12: 23.48, 13: 25.88, 14: 27.28, 15: 28.69, 16: 30.09, 17: 31.50, 18: 32.90 };
                const cet = cetMap[parcelas];
                return { "display": `Parcelado ${parcelas}x`, "forma": `Parcelado ${parcelas}x`, "taxa": parseFloat((cet - 3).toFixed(2)), "servico": 3, "cet": cet };
            }),
            "Hipercard": Array.from({ length: 18 }, (_, i) => {
                const parcelas = i + 1;
                const cetMap = { 1: 6.72, 2: 8.90, 3: 10.29, 4: 11.68, 5: 13.07, 6: 14.44, 7: 16.35, 8: 17.77, 9: 19.20, 10: 20.62, 11: 22.05, 12: 23.48, 13: 25.88, 14: 27.28, 15: 28.69, 16: 30.09, 17: 31.50, 18: 32.90 };
                const cet = cetMap[parcelas];
                return { "display": `Parcelado ${parcelas}x`, "forma": `Parcelado ${parcelas}x`, "taxa": parseFloat((cet - 3).toFixed(2)), "servico": 3, "cet": cet };
            }),
            "Amex": [
                { "display": "Débito", "forma": "Débito", "taxa": 6.00, "servico": 2, "cet": 8.00 },
                ...Array.from({ length: 18 }, (_, i) => {
                    const parcelas = i + 1;
                    const cetMap = { 1: 8.17, 2: 9.04, 3: 10.12, 4: 11.55, 5: 12.99, 6: 14.42, 7: 16.35, 8: 17.77, 9: 19.20, 10: 20.62, 11: 22.05, 12: 23.48, 13: 25.88, 14: 27.28, 15: 28.69, 16: 30.09, 17: 31.50, 18: 32.90 };
                    const cet = cetMap[parcelas];
                    const servico = 3;
                    return { "display": `Parcelado ${parcelas}x`, "forma": `Parcelado ${parcelas}x`, "taxa": parseFloat((cet - servico).toFixed(2)), "servico": servico, "cet": cet };
                })
            ],
            "Cabal": [
                ...Array.from({ length: 18 }, (_, i) => {
                    const parcelas = i + 1;
                    if (parcelas < 3) return null;
                    const cetMap = { 3: 10.12, 4: 11.55, 5: 12.99, 6: 14.42, 7: 16.35, 8: 17.77, 9: 19.20, 10: 20.62, 11: 22.05, 12: 23.48, 13: 25.88, 14: 27.28, 15: 28.69, 16: 30.09, 17: 31.50, 18: 32.90 };
                    const cet = cetMap[parcelas];
                    const servico = 3;
                    return { "display": `Parcelado ${parcelas}x`, "forma": `Parcelado ${parcelas}x`, "taxa": parseFloat((cet - servico).toFixed(2)), "servico": servico, "cet": cet };
                }).filter(Boolean)
            ]
        };

        // Elementos da Calculadora 1
        const saleAmountInput1 = document.getElementById('sale-amount-1');
        const paymentMethodSelect1 = document.getElementById('payment-method-1');
        const profileSelect1 = document.getElementById('profile-select-1');
        const resultsContainer1 = document.getElementById('results-container-1');
        const resultServiceFee1 = document.getElementById('result-service-fee-1');
        const resultRate1 = document.getElementById('result-rate-1');
        const resultCet1 = document.getElementById('result-cet-1');
        const resultNet1 = document.getElementById('result-net-1');
        const calcTitle1 = document.getElementById('calc-title-1');
        const clearCalc1Button = document.getElementById('clear-calc-1');

        // Elementos da Calculadora 2
        const saleAmountInput2 = document.getElementById('sale-amount-2');
        const paymentMethodSelect2 = document.getElementById('payment-method-2');
        const profileSelect2 = document.getElementById('profile-select-2');
        const resultsContainer2 = document.getElementById('results-container-2');
        const resultServiceFee2 = document.getElementById('result-service-fee-2');
        const resultRate2 = document.getElementById('result-rate-2');
        const resultCet2 = document.getElementById('result-cet-2');
        const resultNet2 = document.getElementById('result-net-2');
        const calcTitle2 = document.getElementById('calc-title-2');
        const clearCalc2Button = document.getElementById('clear-calc-2');

        // Outros elementos da UI
        const mainNavContainer = document.getElementById('main-nav-container');
        const pageContents = document.querySelectorAll('.page-content');
        const chartTitleProfiles = document.getElementById('chart-title-profiles');
        const addCustomProfileButton = document.getElementById('add-custom-profile');
        const customMaxParcelasInput = document.getElementById('custom-max-parcelas');
        const addProfileFeedback = document.getElementById('add-profile-feedback');
        const comparisonTableBody = document.getElementById('comparison-table-body');
        const tableHeaderProfile1Group = document.getElementById('table-header-profile1-group');
        const tableHeaderProfile2Group = document.getElementById('table-header-profile2-group');
        const savedCustomProfilesList = document.getElementById('saved-custom-profiles-list');
        const noCustomProfilesMessage = document.getElementById('no-custom-profiles-message');
        const parceladoInputsContainer = document.getElementById('parcelado-inputs-container');
        const toggleCustomProfileButton = document.getElementById('toggle-custom-profile');
        const customProfileContent = document.getElementById('custom-profile-content');
        const hamburgerIcon = document.getElementById('hamburger-icon'); // Re-adicionado

        // Elementos do Modal Personalizado
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        /**
         * Exibe o modal personalizado com uma mensagem específica.
         * @param {string} message - A mensagem a ser exibida no modal.
         * @param {function} [onConfirm] - Função a ser executada se o utilizador confirmar (para caixas de diálogo de confirmação).
         * @param {boolean} [showCancel=false] - Se deve mostrar o botão de cancelar.
         */
        function showCustomModal(message, onConfirm = null, showCancel = false) {
            modalMessage.innerHTML = message; // Usar innerHTML para permitir formatação (negrito)
            customModal.classList.remove('hidden');

            const modalButtons = document.querySelector('.modal-buttons');
            modalButtons.innerHTML = ''; // Limpa botões anteriores

            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.classList.add('bg-blue-600', 'text-white', 'py-2', 'px-4', 'rounded-md', 'shadow-sm', 'hover:bg-blue-700', 'transition-colors', 'font-medium');
            okButton.addEventListener('click', () => {
                hideCustomModal();
                if (onConfirm) {
                    onConfirm();
                }
            });
            modalButtons.appendChild(okButton);

            if (showCancel) {
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancelar';
                cancelButton.classList.add('bg-gray-400', 'text-white', 'py-2', 'px-4', 'rounded-md', 'shadow-sm', 'hover:bg-gray-500', 'transition-colors', 'font-medium', 'ml-2');
                cancelButton.addEventListener('click', hideCustomModal);
                modalButtons.appendChild(cancelButton);
            }
        }

        /**
         * Oculta o modal personalizado.
         */
        function hideCustomModal() {
            customModal.classList.add('hidden');
        }

        // Listener para fechar o modal (apenas para o botão OK padrão, o showCustomModal recria os botões)
        modalCloseButton.addEventListener('click', hideCustomModal);

        /**
         * Salva os perfis personalizados no localStorage.
         */
        function saveCustomProfiles() {
            try {
                localStorage.setItem('customProfilesCPAG40', JSON.stringify(customProfiles));
                console.log("Perfis guardados no localStorage.");
            } catch (e) {
                console.error("Erro ao guardar perfis no localStorage:", e);
                showCustomModal("Erro: Não foi possível guardar os perfis. O armazenamento local pode estar cheio ou desativado.");
            }
        }

        /**
         * Carrega os perfis personalizados do localStorage.
         */
        function loadCustomProfiles() {
            try {
                const storedProfiles = localStorage.getItem('customProfilesCPAG40');
                if (storedProfiles) {
                    customProfiles = JSON.parse(storedProfiles);
                    console.log("Perfis carregados do localStorage.");
                } else {
                    customProfiles = {}; // Garante que é um objeto vazio se não houver dados
                    console.log("Nenhum perfil encontrado no localStorage. Iniciando com perfis vazios.");
                }
            } catch (e) {
                console.error("Erro ao carregar perfis do localStorage:", e);
                showCustomModal("Erro: Não foi possível carregar os perfis guardados. Os dados podem estar corrompidos.");
                customProfiles = {}; // Limpa perfis em caso de erro de carregamento
            }
        }

        /**
         * Exibe a página selecionada e oculta as outras.
         * Atualiza o estado visual dos botões de navegação.
         * @param {string} pageId - O ID da página a ser exibida.
         */
        function showPage(pageId) {
            pageContents.forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            currentPage = pageId;
            updateActiveButton();
            // Fecha o menu hambúrguer se estiver aberto ao navegar para uma nova página
            if (mainNavContainer.classList.contains('open')) {
                mainNavContainer.classList.remove('open');
                hamburgerIcon.classList.remove('open');
            }

            // Atualiza o conteúdo específico da página ao exibi-la
            if (pageId === 'chart-page') {
                updateChart();
            } else if (pageId === 'calculators-page') {
                updateCalculatorUI(1);
                updateCalculatorUI(2);
            } else if (pageId === 'comparison-details-page') {
                updateComparisonTable();
            } else if (pageId === 'custom-profile-page') {
                displaySavedCustomProfiles();
                updateParceladoInputsVisibility();
            }
        }

        /**
         * Atualiza o estado visual do botão de navegação ativo.
         */
        function updateActiveButton() {
            document.querySelectorAll('.page-nav-button').forEach(btn => {
                if (btn.dataset.page === currentPage) {
                    btn.classList.add('bg-orange-500', 'text-white');
                    btn.classList.remove('bg-orange-100', 'text-orange-800');
                    btn.setAttribute('aria-selected', 'true');
                } else {
                    btn.classList.remove('bg-orange-500', 'text-white');
                    btn.classList.add('bg-orange-100', 'text-orange-800');
                    btn.setAttribute('aria-selected', 'false');
                }
            });
        }

        /**
         * Função principal para inicializar e atualizar a aplicação.
         */
        function updateApp() {
            populateAllProfileSelect(profileSelect1, profileSelect1.value || currentBrand);
            populateCustomProfileSelect(profileSelect2, profileSelect2.value);
            showPage(currentPage);
        }

        /**
         * Formata um valor numérico para o formato de moeda BRL.
         * @param {number} value - O valor a ser formatado.
         * @returns {string} O valor formatado como moeda.
         */
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        /**
         * Retorna os dados de um perfil de taxas (taxas e máximo de parcelas).
         * Pode ser um perfil pré-definido ou um perfil personalizado.
         * @param {string} profileName - O nome do perfil.
         * @returns {{data: Array, max_parcelas: number}} Os dados do perfil e o número máximo de parcelas.
         */
        function getProfileData(profileName) {
            let data = [];
            let maxParcelas = 18;

            if (allRates[profileName]) {
                data = allRates[profileName];
            } else if (customProfiles[profileName]) {
                const profile = customProfiles[profileName];
                maxParcelas = profile.max_parcelas;
                const serviceRate = profile.service_rate;
                const taxaPix = profile.taxa_pix;
                const taxaDebit = profile.taxa_debit;
                const parceladoRates = profile.parceladoRates;

                data.push({
                    "display": "PIX",
                    "forma": "PIX",
                    "taxa": taxaPix,
                    "servico": serviceRate,
                    "cet": parseFloat((taxaPix + serviceRate).toFixed(2))
                });

                data.push({
                    "display": "Débito",
                    "forma": "Débito",
                    "taxa": taxaDebit,
                    "servico": serviceRate,
                    "cet": parseFloat((taxaDebit + serviceRate).toFixed(2))
                });

                for (let i = 1; i <= 18; i++) {
                    const taxa = parceladoRates[i - 1];
                    const servico = serviceRate;
                    const cet = parseFloat((taxa + servico).toFixed(2));
                    data.push({
                        "display": `Parcelado ${i}x`,
                        "forma": `Parcelado ${i}x`,
                        "taxa": taxa,
                        "servico": servico,
                        "cet": cet
                    });
                }
            }
            return { data: data, max_parcelas: maxParcelas };
        }

        /**
         * Atualiza o gráfico de comparação de economia.
         * Exibe as taxas CET de dois perfis selecionados ao longo das parcelas.
         */
        function updateChart() {
            const profile1Name = profileSelect1.value;
            const profile2Name = profileSelect2.value;

            const profile1Result = getProfileData(profile1Name);
            const profile2Result = getProfileData(profile2Name);

            const profile1Data = profile1Result.data;
            const profile1MaxParcelas = profile1Result.max_parcelas;

            const profile2Data = profile2Result.data;
            const profile2MaxParcelas = profile2Result.max_parcelas;

            let chartMaxInstallments = 0;
            if (profile1Name && profile2Name && profile1Name !== profile2Name) {
                chartMaxInstallments = Math.min(profile1MaxParcelas, profile2MaxParcelas);
            } else if (profile1Name) {
                chartMaxInstallments = profile1MaxParcelas;
            } else if (profile2Name) {
                chartMaxInstallments = profile2MaxParcelas;
            }
            if (chartMaxInstallments === 0) chartMaxInstallments = 18;

            const labels = ['PIX', 'Débito', ...Array.from({ length: chartMaxInstallments }, (_, i) => `${i + 1}x`)];

            const data1 = labels.map(label => {
                if (label === 'PIX') {
                    const pixMatch = profile1Data.find(d => d.forma === 'PIX');
                    return pixMatch ? pixMatch.cet : null;
                } else if (label === 'Débito') {
                    const debitMatch = profile1Data.find(d => d.forma === 'Débito');
                    return debitMatch ? debitMatch.cet : null;
                } else {
                    const installmentNum = parseInt(label.replace('x', ''));
                    if (installmentNum > profile1MaxParcelas) return null;
                    const match = profile1Data.find(d => d.display === `Parcelado ${label}`);
                    return match ? match.cet : null;
                }
            });
            const data2 = labels.map(label => {
                if (label === 'PIX') {
                    const pixMatch = profile2Data.find(d => d.forma === 'PIX');
                    return pixMatch ? pixMatch.cet : null;
                } else if (label === 'Débito') {
                    const debitMatch = profile2Data.find(d => d.forma === 'Débito');
                    return debitMatch ? debitMatch.cet : null;
                } else {
                    const installmentNum = parseInt(label.replace('x', ''));
                    if (installmentNum > profile2MaxParcelas) return null;
                    const match = profile2Data.find(d => d.display === `Parcelado ${label}`);
                    return match ? match.cet : null;
                }
            });

            let datasets = [];

            const avgCet1 = data1.filter(val => val !== null).reduce((sum, val) => sum + val, 0) / data1.filter(val => val !== null).length;
            const avgCet2 = data2.filter(val => val !== null).reduce((sum, val) => sum + val, 0) / data2.filter(val => val !== null).length;

            let color1 = '#2563eb';
            let color2 = '#2563eb';

            let chartTitle = '';
            if (profile1Name && profile2Name && profile1Name !== profile2Name) {
                chartTitle = `(${profile1Name} vs ${profile2Name})`;
                if (data1.filter(val => val !== null).length > 0 && data2.filter(val => val !== null).length > 0 && !isNaN(avgCet1) && !isNaN(avgCet2)) {
                    if (avgCet1 < avgCet2) {
                        color1 = '#22c55e';
                        color2 = '#ef4444';
                    } else if (avgCet2 < avgCet1) {
                        color1 = '#ef4444';
                        color2 = '#22c55e';
                    }
                }
            } else if (profile1Name) {
                chartTitle = `(${profile1Name})`;
            } else if (profile2Name) {
                chartTitle = `(${profile2Name})`;
            }
            chartTitleProfiles.textContent = chartTitle;


            if (profile1Data.length > 0) {
                datasets.push({
                    label: `CET (%) - ${profile1Name}`,
                    data: data1,
                    borderColor: color1,
                    backgroundColor: color1 + '1A',
                    borderWidth: 2,
                    pointBackgroundColor: color1,
                    tension: 0.1,
                    spanGaps: true,
                    fill: false,
                });
            }
            if (profile2Data.length > 0 && profile1Name !== profile2Name) {
                datasets.push({
                    label: `CET (%) - ${profile2Name}`,
                    data: data2,
                    borderColor: color2,
                    backgroundColor: color2 + '1A',
                    borderWidth: 2,
                    pointBackgroundColor: color2,
                    tension: 0.1,
                    spanGaps: true,
                    fill: false,
                });
            }

            const ctx = document.getElementById('rateChart').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy();
            }
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'CET (%)' }
                        },
                        x: {
                            title: { display: true, text: 'Forma de Pagamento / Nº de Parcelas' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y !== null ? context.parsed.y.toFixed(2) : 'N/A'}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Preenche um elemento select com todos os perfis de taxas disponíveis (pré-definidos e personalizados).
         * @param {HTMLSelectElement} selectElement - O elemento select a ser preenchido.
         * @param {string} defaultProfile - O nome do perfil a ser selecionado por padrão.
         */
        function populateAllProfileSelect(selectElement, defaultProfile) {
            selectElement.innerHTML = '';
            const allProfileNames = [...Object.keys(allRates), ...Object.keys(customProfiles)];
            allProfileNames.forEach(profileName => {
                const option = document.createElement('option');
                option.value = profileName;
                option.textContent = profileName;
                selectElement.appendChild(option);
            });
            if (defaultProfile) {
                selectElement.value = defaultProfile;
            } else if (allProfileNames.length > 0) {
                selectElement.value = allProfileNames[0];
            }
        }

        /**
         * Preenche um elemento select apenas com perfis de taxas personalizados.
         * @param {HTMLSelectElement} selectElement - O elemento select a ser preenchido.
         * @param {string} [defaultProfile] - O nome do perfil a ser selecionado por padrão.
         */
        function populateCustomProfileSelect(selectElement, defaultProfile) {
            selectElement.innerHTML = '';
            const customProfileNames = Object.keys(customProfiles);
            if (customProfileNames.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Nenhum Perfil Personalizado";
                selectElement.appendChild(option);
                selectElement.disabled = true;
            } else {
                selectElement.disabled = false;
                customProfileNames.forEach(profileName => {
                    const option = document.createElement('option');
                    option.value = profileName;
                    option.textContent = profileName;
                    selectElement.appendChild(option);
                });
                if (defaultProfile && customProfileNames.includes(defaultProfile)) {
                    selectElement.value = defaultProfile;
                } else if (customProfileNames.length > 0) {
                    selectElement.value = customProfileNames[0];
                }
            }
        }

        /**
         * Atualiza a interface da calculadora (menu suspenso de método de pagamento e título).
         * @param {number} calculatorId - O ID da calculadora (1 ou 2).
         */
        function updateCalculatorUI(calculatorId) {
            const profileSelect = document.getElementById(`profile-select-${calculatorId}`);
            const paymentMethodSelect = document.getElementById(`payment-method-${calculatorId}`);
            const selectedProfileName = profileSelect.value;
            
            const profileResult = getProfileData(selectedProfileName);
            let brandData = profileResult.data;
            const profileMaxParcelas = profileResult.max_parcelas;

            const currentPaymentMethodValue = paymentMethodSelect.value;

            const calcTitleElement = document.getElementById(`calc-title-${calculatorId}`);
            if (calculatorId === 2) {
                calcTitleElement.textContent = selectedProfileName ? `${selectedProfileName}` : '';
                brandData = brandData.filter(method => {
                    if (method.forma.startsWith('Parcelado')) {
                        const parcelas = parseInt(method.forma.replace('Parcelado ', '').replace('x', ''));
                        return parcelas <= profileMaxParcelas;
                    }
                    return true;
                });
            } else if (calculatorId === 1) {
                const profile2Name = profileSelect2.value;
                const profile2ResultForCalc1 = getProfileData(profile2Name);
                const maxParcelasForCalc1Dropdown = profile2ResultForCalc1.max_parcelas;

                brandData = brandData.filter(method => {
                    if (method.forma.startsWith('Parcelado')) {
                        const parcelas = parseInt(method.forma.replace('Parcelado ', '').replace('x', ''));
                        return parcelas <= maxParcelasForCalc1Dropdown;
                    }
                    return true;
                });
            }

            paymentMethodSelect.innerHTML = '';
            if (brandData.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "N/A";
                paymentMethodSelect.appendChild(option);
                paymentMethodSelect.disabled = true;
            } else {
                paymentMethodSelect.disabled = false;
                brandData.forEach((method, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = method.display;
                    paymentMethodSelect.appendChild(option);
                });

                if (currentPaymentMethodValue !== "" && brandData[currentPaymentMethodValue]) {
                    paymentMethodSelect.value = currentPaymentMethodValue;
                } else {
                    paymentMethodSelect.value = 0;
                }
            }
            calculateFees(calculatorId);
        }

        /**
         * Calcula as taxas e o valor líquido a receber para uma calculadora específica.
         * @param {number} calculatorId - O ID da calculadora (1 ou 2).
         */
        function calculateFees(calculatorId) {
            const saleAmountInput = document.getElementById(`sale-amount-${calculatorId}`);
            const paymentMethodSelect = document.getElementById(`payment-method-${calculatorId}`);
            const profileSelect = document.getElementById(`profile-select-${calculatorId}`);
            const resultsContainer = document.getElementById(`results-container-${calculatorId}`);

            const amount = parseFloat(saleAmountInput.value);
            const selectedIndex = paymentMethodSelect.value;
            const selectedProfileName = profileSelect.value;

            if (isNaN(amount) || amount <= 0 || selectedIndex === "" || selectedProfileName === "") {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const methodData = getProfileData(selectedProfileName).data;
            const method = methodData[selectedIndex];
            if (!method) {
                resultsContainer.classList.add('hidden');
                return;
            }

            const cetFee = (amount * method.cet) / 100;
            const netAmount = amount - cetFee;
            const serviceFeeValue = (amount * method.servico) / 100;
            const rateFeeValue = (amount * method.taxa) / 100;

            document.getElementById(`result-service-fee-${calculatorId}`).textContent = `${formatCurrency(serviceFeeValue)} (${method.servico.toFixed(2)}%)`;
            document.getElementById(`result-rate-${calculatorId}`).textContent = `${formatCurrency(rateFeeValue)} (${method.taxa.toFixed(2)}%)`;
            document.getElementById(`result-cet-${calculatorId}`).textContent = `${formatCurrency(cetFee)} (${method.cet.toFixed(2)}%)`;
            document.getElementById(`result-net-${calculatorId}`).textContent = formatCurrency(netAmount);

            resultsContainer.classList.remove('hidden');
        }

        /**
         * Limpa os campos de uma calculadora específica.
         * @param {number} calculatorId - O ID da calculadora (1 ou 2).
         */
        function clearCalculator(calculatorId) {
            document.getElementById(`sale-amount-${calculatorId}`).value = '';
            document.getElementById(`payment-method-${calculatorId}`).value = '';
            document.getElementById(`results-container-${calculatorId}`).classList.add('hidden');
            if (calculatorId === 1) {
                populateAllProfileSelect(profileSelect1, currentBrand);
            } else {
                populateCustomProfileSelect(profileSelect2);
            }
            updateCalculatorUI(calculatorId);
        }

        /**
         * Adiciona um novo perfil personalizado com base nos dados inseridos pelo utilizador.
         * Ou atualiza um perfil existente se `editingProfileName` estiver definido.
         */
        async function addCustomProfile() {
            const name = document.getElementById('custom-profile-name').value.trim();
            const serviceRate = parseFloat(document.getElementById('custom-service-rate').value);
            const taxaPix = parseFloat(document.getElementById('custom-rate-pix').value);
            const taxaDebit = parseFloat(document.getElementById('custom-rate-debit').value);
            const maxParcelas = parseInt(customMaxParcelasInput.value);

            const parceladoRates = [];
            let allRequiredParceladoRatesValid = true; 
            for (let i = 1; i <= 18; i++) {
                const input = document.getElementById(`custom-rate-parcelado-${i}x`);
                const rate = parseFloat(input.value);
                
                if (i <= maxParcelas) {
                    if (isNaN(rate)) {
                        allRequiredParceladoRatesValid = false;
                        break;
                    }
                    parceladoRates.push(rate);
                } else {
                    parceladoRates.push(isNaN(rate) ? 0 : rate);
                }
            }

            if (!name || isNaN(serviceRate) || isNaN(taxaPix) || isNaN(taxaDebit) || !allRequiredParceladoRatesValid || isNaN(maxParcelas) || maxParcelas < 1 || maxParcelas > 18) {
                showCustomModal('Por favor, preencha todos os campos obrigatórios do perfil personalizado com valores válidos (incluindo a taxa de serviço, as taxas PIX e Débito, o máximo de parcelas entre 1 e 18, e as taxas da bandeira até o máximo de parcelas definido).');
                return;
            }

            if (editingProfileName && editingProfileName !== name) {
                if (allRates[name] || customProfiles[name]) {
                    showCustomModal('Já existe um perfil com este novo nome. Por favor, escolha um nome diferente.');
                    return;
                }
                // Se o nome foi alterado, remove o perfil antigo do objeto local e do localStorage
                delete customProfiles[editingProfileName];
            } else if (!editingProfileName && (allRates[name] || customProfiles[name])) {
                showCustomModal('Já existe um perfil com este nome. Por favor, escolha um nome diferente.');
                return;
            }

            try {
                const profileData = {
                    name: name,
                    service_rate: serviceRate,
                    taxa_pix: taxaPix,
                    taxa_debit: taxaDebit,
                    parceladoRates: parceladoRates,
                    max_parcelas: maxParcelas
                };
                // Adiciona ou atualiza o perfil no objeto local
                customProfiles[name] = profileData;
                saveCustomProfiles(); // Guarda no localStorage

                // Limpa os campos de entrada e redefine o estado de edição
                document.getElementById('custom-profile-name').value = '';
                document.getElementById('custom-service-rate').value = '';
                document.getElementById('custom-rate-pix').value = '';
                document.getElementById('custom-rate-debit').value = '';
                for (let i = 1; i <= 18; i++) {
                    document.getElementById(`custom-rate-parcelado-${i}x`).value = '';
                }
                customMaxParcelasInput.value = '18';

                editingProfileName = null;
                addCustomProfileButton.textContent = 'Adicionar Perfil Personalizado';

                addProfileFeedback.classList.remove('hidden');
                setTimeout(() => {
                    addProfileFeedback.classList.add('hidden');
                }, 3000);

                customProfileContent.classList.add('hidden');
                toggleCustomProfileButton.textContent = '+';

                // Atualiza a UI com os novos dados
                updateApp();
            } catch (error) {
                console.error("Erro ao adicionar/atualizar perfil:", error);
                showCustomModal(`Erro ao guardar perfil: ${error.message}`);
            }
        }

        /**
         * Preenche os campos de input do perfil personalizado com os dados do perfil selecionado para edição.
         * @param {string} profileName - O nome do perfil a ser editado.
         */
        function editCustomProfile(profileName) {
            const profile = customProfiles[profileName];
            if (profile) {
                editingProfileName = profileName;

                document.getElementById('custom-profile-name').value = profile.name;
                document.getElementById('custom-service-rate').value = profile.service_rate;
                document.getElementById('custom-rate-pix').value = profile.taxa_pix;
                document.getElementById('custom-rate-debit').value = profile.taxa_debit;
                customMaxParcelasInput.value = profile.max_parcelas;

                for (let i = 1; i <= 18; i++) {
                    const input = document.getElementById(`custom-rate-parcelado-${i}x`);
                    if (input) {
                        input.value = profile.parceladoRates[i - 1] !== undefined ? profile.parceladoRates[i - 1] : '';
                    }
                }

                updateParceladoInputsVisibility();

                addCustomProfileButton.textContent = 'Salvar Alterações';
                
                if (customProfileContent.classList.contains('hidden')) {
                    customProfileContent.classList.remove('hidden');
                    toggleCustomProfileButton.textContent = '-';
                }

                showPage('custom-profile-page');
            }
        }

        /**
         * Remove um perfil personalizado do objeto local e do localStorage.
         * @param {string} profileName - O nome do perfil a ser removido.
         */
        async function deleteCustomProfile(profileName) {
            showCustomModal(`Tem certeza que deseja apagar o perfil "<b>${profileName}</b>"?`, () => {
                delete customProfiles[profileName];
                saveCustomProfiles(); // Guarda no localStorage
                showCustomModal(`Perfil "<b>${profileName}</b>" removido com sucesso!`);
                updateApp(); // Atualiza a UI
            }, true); // showCancel = true
        }

        /**
         * Exibe os perfis personalizados salvos na lista.
         */
        function displaySavedCustomProfiles() {
            savedCustomProfilesList.innerHTML = '';
            const customProfileNames = Object.keys(customProfiles);

            if (customProfileNames.length === 0) {
                noCustomProfilesMessage.classList.remove('hidden');
            } else {
                noCustomProfilesMessage.classList.add('hidden');
                customProfileNames.forEach(profileName => {
                    const profileDiv = document.createElement('div');
                    profileDiv.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'bg-gray-100', 'rounded-md', 'shadow-sm');
                    profileDiv.innerHTML = `
                        <span class="font-medium text-gray-700">${profileName}</span>
                        <div class="flex space-x-2">
                            <button class="compare-profile-button bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 transition-colors" data-profile-name="${profileName}">Comparar</button>
                            <button class="edit-profile-button bg-orange-500 text-white px-3 py-1 rounded-md text-sm hover:bg-orange-600 transition-colors" data-profile-name="${profileName}">Editar</button>
                            <button class="delete-profile-button bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition-colors" data-profile-name="${profileName}">Apagar</button>
                        </div>
                    `;
                    savedCustomProfilesList.appendChild(profileDiv);
                });

                document.querySelectorAll('.edit-profile-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const profileName = event.target.dataset.profileName;
                        editCustomProfile(profileName);
                    });
                });

                document.querySelectorAll('.delete-profile-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const profileName = event.target.dataset.profileName;
                        deleteCustomProfile(profileName); // Usa o modal personalizado
                    });
                });

                document.querySelectorAll('.compare-profile-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const profileName = event.target.dataset.profileName;
                        populateCustomProfileSelect(profileSelect2, profileName);
                        updateCalculatorUI(2);
                        profileSelect1.value = currentBrand;
                        updateCalculatorUI(1);
                        showPage('comparison-details-page');
                    });
                });
            }
        }

        /**
         * Inicializa os campos de input de parcelas dinamicamente.
         * Cria todos os 18 campos, mas os oculta inicialmente.
         */
        function initializeParceladoInputs() {
            parceladoInputsContainer.innerHTML = '<div class="col-span-full text-sm font-semibold text-gray-700 mt-2 mb-1">Taxas da Bandeira (Parcelado por X) %</div>';
            for (let i = 1; i <= 18; i++) {
                const div = document.createElement('div');
                div.id = `parcelado-input-group-${i}x`;
                div.classList.add('hidden');
                div.innerHTML = `
                    <label for="custom-rate-parcelado-${i}x" class="block text-xs font-medium text-gray-700">Parcelado ${i}x</label>
                    <input type="number" id="custom-rate-parcelado-${i}x" placeholder="0.00" step="0.01" class="mt-1 block w-full px-2 py-1 bg-white border border-slate-300 rounded-md text-xs shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                `;
                parceladoInputsContainer.appendChild(div);
            }
        }

        /**
         * Controla a visibilidade dos campos de input de parcelas com base no valor de 'Máximo de Parcelas para Comparativo'.
         */
        function updateParceladoInputsVisibility() {
            const maxParcelas = parseInt(customMaxParcelasInput.value);
            for (let i = 1; i <= 18; i++) {
                const inputGroup = document.getElementById(`parcelado-input-group-${i}x`);
                if (inputGroup) {
                    if (i <= maxParcelas) {
                        inputGroup.classList.remove('hidden');
                    } else {
                        inputGroup.classList.add('hidden');
                    }
                }
            }
        }

        /**
         * Atualiza a tabela de comparação de taxas.
         */
        function updateComparisonTable() {
            const profile1Name = profileSelect1.value;
            const profile2Name = profileSelect2.value;
            const saleAmount = parseFloat(saleAmountInput1.value) || 100;

            tableHeaderProfile1Group.textContent = profile1Name;
            tableHeaderProfile2Group.textContent = profile2Name;

            comparisonTableBody.innerHTML = '';

            if (!profile1Name || !profile2Name) {
                return;
            }

            const profile1Result = getProfileData(profile1Name);
            const profile2Result = getProfileData(profile2Name);

            const profile1Data = profile1Result.data;
            const profile1MaxParcelas = profile1Result.max_parcelas;

            const profile2Data = profile2Result.data;
            const profile2MaxParcelas = profile2Result.max_parcelas;

            const tableMaxInstallments = Math.min(profile1MaxParcelas, profile2MaxParcelas);

            const pixRow = document.createElement('tr');
            pixRow.classList.add('border-b', 'border-gray-300');
            const pixMethod1 = profile1Data.find(d => d.forma === 'PIX');
            const pixMethod2 = profile2Data.find(d => d.forma === 'PIX');

            if (pixMethod1 && pixMethod2) {
                const servico1 = pixMethod1.servico;
                const taxa1 = pixMethod1.taxa;
                const cet1 = pixMethod1.cet;
                const net1 = saleAmount * (1 - cet1 / 100);

                const servico2 = pixMethod2.servico;
                const taxa2 = pixMethod2.taxa;
                const cet2 = pixMethod2.cet;
                const net2 = saleAmount * (1 - cet2 / 100);
                
                const economyValue = net1 - net2;
                let economyPercentage = 0;
                if (cet1 !== cet2) {
                    economyPercentage = ((Math.max(cet1, cet2) - Math.min(cet1, cet2)) / Math.max(cet1, cet2)) * 100;
                }

                pixRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">PIX</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(saleAmount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${taxa1.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${servico1.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${cet1.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${formatCurrency(net1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${taxa2.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${servico2.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${cet2.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${formatCurrency(net2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${economyValue > 0 ? 'text-green-600' : (economyValue < 0 ? 'text-red-600' : 'text-gray-500')}">
                        ${economyValue !== 0 ? formatCurrency(Math.abs(economyValue)) : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${economyValue > 0 ? 'text-green-600' : (economyValue < 0 ? 'text-red-600' : 'text-gray-500')}">
                        ${economyValue !== 0 ? economyPercentage.toFixed(2) + '%' : 'N/A'}
                    </td>
                `;
                comparisonTableBody.appendChild(pixRow);
            }

            const debitRow = document.createElement('tr');
            debitRow.classList.add('border-b', 'border-gray-300');
            const debitMethod1 = profile1Data.find(d => d.forma === 'Débito');
            const debitMethod2 = profile2Data.find(d => d.forma === 'Débito');

            if (debitMethod1 && debitMethod2) {
                const servico1 = debitMethod1.servico;
                const taxa1 = debitMethod1.taxa;
                const cet1 = debitMethod1.cet;
                const net1 = saleAmount * (1 - cet1 / 100);

                const servico2 = debitMethod2.servico;
                const taxa2 = debitMethod2.taxa;
                const cet2 = debitMethod2.cet;
                const net2 = saleAmount * (1 - cet2 / 100);
                
                const economyValue = net1 - net2;
                let economyPercentage = 0;
                if (cet1 !== cet2) {
                    economyPercentage = ((Math.max(cet1, cet2) - Math.min(cet1, cet2)) / Math.max(cet1, cet2)) * 100;
                }

                debitRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Débito</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(saleAmount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${taxa1.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${servico1.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${cet1.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${formatCurrency(net1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${taxa2.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${servico2.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${cet2.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${formatCurrency(net2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${economyValue > 0 ? 'text-green-600' : (economyValue < 0 ? 'text-red-600' : 'text-gray-500')}">
                        ${economyValue !== 0 ? formatCurrency(Math.abs(economyValue)) : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${economyValue > 0 ? 'text-green-600' : (economyValue < 0 ? 'text-red-600' : 'text-gray-500')}">
                        ${economyValue !== 0 ? economyPercentage.toFixed(2) + '%' : 'N/A'}
                    </td>
                `;
                comparisonTableBody.appendChild(debitRow);
            }

            for (let i = 1; i <= tableMaxInstallments; i++) {
                const installmentRow = document.createElement('tr');
                installmentRow.classList.add('border-b', 'border-gray-300');
                const installmentMethod1 = profile1Data.find(d => d.forma === `Parcelado ${i}x`);
                const installmentMethod2 = profile2Data.find(d => d.forma === `Parcelado ${i}x`);

                if (installmentMethod1 && installmentMethod2) {
                    const servico1 = installmentMethod1.servico;
                    const taxa1 = installmentMethod1.taxa;
                    const cet1 = installmentMethod1.cet;
                    const net1 = saleAmount * (1 - cet1 / 100);

                    const servico2 = installmentMethod2.servico;
                    const taxa2 = installmentMethod2.taxa;
                    const cet2 = installmentMethod2.cet;
                    const net2 = saleAmount * (1 - cet2 / 100);
                    
                    const economyValue = net1 - net2;
                    let economyPercentage = 0;
                    if (cet1 !== cet2) {
                        economyPercentage = ((Math.max(cet1, cet2) - Math.min(cet1, cet2)) / Math.max(cet1, cet2)) * 100;
                    }

                    installmentRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Parcelado ${i}x</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(saleAmount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${taxa1.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${servico1.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${cet1.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-blue-100">${formatCurrency(net1)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${taxa2.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${servico2.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${cet2.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 bg-green-100">${formatCurrency(net2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${economyValue > 0 ? 'text-green-600' : (economyValue < 0 ? 'text-red-600' : 'text-gray-500')}">
                            ${economyValue !== 0 ? formatCurrency(Math.abs(economyValue)) : 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${economyValue > 0 ? 'text-green-600' : (economyValue < 0 ? 'text-red-600' : 'text-gray-500')}">
                            ${economyValue !== 0 ? economyPercentage.toFixed(2) + '%' : 'N/A'}
                        </td>
                    `;
                    comparisonTableBody.appendChild(installmentRow);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Carrega os perfis guardados no localStorage ao iniciar
            loadCustomProfiles();

            // Listeners de Eventos para a Calculadora 1
            saleAmountInput1.addEventListener('input', () => { calculateFees(1); updateComparisonTable(); }); 
            paymentMethodSelect1.addEventListener('change', () => updateCalculatorUI(1)); 
            profileSelect1.addEventListener('change', () => updateCalculatorUI(1));
            clearCalc1Button.addEventListener('click', () => clearCalculator(1));

            // Listeners de Eventos para a Calculadora 2
            saleAmountInput2.addEventListener('input', () => { calculateFees(2); updateComparisonTable(); }); 
            paymentMethodSelect2.addEventListener('change', () => updateCalculatorUI(2)); 
            profileSelect2.addEventListener('change', () => updateCalculatorUI(2));
            clearCalc2Button.addEventListener('click', () => clearCalculator(2));

            // Outros listeners de eventos
            addCustomProfileButton.addEventListener('click', addCustomProfile);
            customMaxParcelasInput.addEventListener('input', updateParceladoInputsVisibility);

            // Listener para o menu hambúrguer
            hamburgerIcon.addEventListener('click', () => {
                mainNavContainer.classList.toggle('open');
                hamburgerIcon.classList.toggle('open');
            });

            document.querySelectorAll('.page-nav-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    showPage(event.target.dataset.page);
                });
            });

            toggleCustomProfileButton.addEventListener('click', () => {
                customProfileContent.classList.toggle('hidden');
                if (customProfileContent.classList.contains('hidden')) {
                    toggleCustomProfileButton.textContent = '+';
                } else {
                    toggleCustomProfileButton.textContent = '-';
                }
            });
            
            initializeParceladoInputs();
            updateApp(); // Carregamento inicial da aplicação

            // NOVO: Listener para redimensionamento da janela
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) { // Se a largura da tela for maior ou igual ao breakpoint 'lg' do Tailwind
                    mainNavContainer.classList.remove('hidden', 'open'); // Garante que a navegação principal esteja visível
                    mainNavContainer.style.display = 'flex'; // Força display flex
                    hamburgerIcon.classList.add('hidden'); // Oculta o ícone do hambúrguer
                    hamburgerIcon.classList.remove('open'); // Remove a classe 'open' do hambúrguer
                } else {
                    // Em telas menores, o CSS já lida com a exibição do hambúrguer e ocultação da navegação
                    // Apenas garante que o hambúrguer esteja visível e a navegação oculta se não estiver "aberta"
                    hamburgerIcon.classList.remove('hidden');
                    if (!mainNavContainer.classList.contains('open')) {
                         mainNavContainer.style.display = 'none';
                    }
                }
            });

            // Chama a função de redimensionamento uma vez ao carregar para definir o estado inicial correto
            window.dispatchEvent(new Event('resize'));
        });
    </script>
</body>
</html>
